{% extends "base.html" %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
    .monitor-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .monitor-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #007bff;
    }
    
    .monitor-controls {
        display: flex;
        gap: 10px;
        align-items: center;
    }
    
    .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
    }
    
    .status-running {
        background-color: #28a745;
        animation: pulse 2s infinite;
    }
    
    .status-stopped {
        background-color: #dc3545;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
    
    .message-filters {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
    }
    
    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    
    .filter-group label {
        font-weight: 600;
        font-size: 0.9em;
        color: #495057;
    }
    
    .filter-group select,
    .filter-group input {
        padding: 8px 12px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 0.9em;
    }
    
    .messages-container {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        overflow: hidden;
    }
    
    .messages-header {
        background: #e9ecef;
        padding: 15px 20px;
        border-bottom: 1px solid #dee2e6;
        font-weight: 600;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .message-count {
        background: #007bff;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8em;
    }
    
    .messages-list {
        max-height: 600px;
        overflow-y: auto;
    }
    
    .message-item {
        padding: 15px 20px;
        border-bottom: 1px solid #f1f3f4;
        transition: background-color 0.2s;
    }
    
    .message-item:hover {
        background-color: #f8f9fa;
    }
    
    .message-item:last-child {
        border-bottom: none;
    }
    
    .message-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }
    
    .message-source {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8em;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .source-mqtt {
        background-color: #d4edda;
        color: #155724;
    }
    
    .source-redis {
        background-color: #d1ecf1;
        color: #0c5460;
    }
    
    .message-timestamp {
        color: #6c757d;
        font-size: 0.9em;
    }
    
    .message-topic {
        font-family: 'Courier New', monospace;
        font-weight: 600;
        color: #495057;
        margin-bottom: 8px;
        word-break: break-all;
    }
    
    .message-payload {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 4px;
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
        white-space: pre-wrap;
        word-break: break-word;
        border-left: 3px solid #007bff;
        max-height: 300px;
        overflow-y: auto;
        position: relative;
    }
    
    .message-payload.json {
        background: #f8f9fa;
        border-left-color: #28a745;
    }
    
    .message-payload.raw {
        background: #fff3cd;
        border-left-color: #ffc107;
    }
    
    .payload-type {
        position: absolute;
        top: 5px;
        right: 10px;
        font-size: 0.7em;
        padding: 2px 6px;
        border-radius: 3px;
        font-weight: bold;
        text-transform: uppercase;
    }
    
    .payload-type.json {
        background: #d4edda;
        color: #155724;
    }
    
    .payload-type.raw {
        background: #fff3cd;
        color: #856404;
    }
    
    .json-key {
        color: #0066cc;
        font-weight: bold;
    }
    
    .json-string {
        color: #008800;
    }
    
    .json-number {
        color: #cc6600;
    }
    
    .json-boolean {
        color: #9900cc;
        font-weight: bold;
    }
    
    .json-null {
        color: #999999;
        font-style: italic;
    }
    
    .payload-content {
        margin-top: 20px;
        line-height: 1.4;
    }
    
    .message-payload.json .payload-content {
        font-size: 0.85em;
    }
    
    .message-payload.raw .payload-content {
        font-size: 0.9em;
    }
    
    .message-meta {
        display: flex;
        gap: 15px;
        margin-top: 8px;
        font-size: 0.8em;
        color: #6c757d;
    }
    
    .meta-item {
        display: flex;
        align-items: center;
        gap: 4px;
    }
    
    .no-messages {
        text-align: center;
        padding: 40px;
        color: #6c757d;
    }
    
    .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
        font-weight: 500;
        text-decoration: none;
        display: inline-block;
        transition: all 0.2s;
    }
    
    .btn-primary {
        background-color: #007bff;
        color: white;
    }
    
    .btn-primary:hover {
        background-color: #0056b3;
    }
    
    .btn-success {
        background-color: #28a745;
        color: white;
    }
    
    .btn-success:hover {
        background-color: #1e7e34;
    }
    
    .btn-danger {
        background-color: #dc3545;
        color: white;
    }
    
    .btn-danger:hover {
        background-color: #c82333;
    }
    
    .btn-secondary {
        background-color: #6c757d;
        color: white;
    }
    
    .btn-secondary:hover {
        background-color: #545b62;
    }
    
    .auto-refresh {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9em;
        color: #495057;
    }
    
    .auto-refresh input[type="checkbox"] {
        margin: 0;
    }
    
    .connection-status {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.9em;
    }
    
    .connection-item {
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .connection-ok {
        color: #28a745;
    }
    
    .connection-error {
        color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div class="monitor-container">
    <div class="monitor-header">
        <div>
            <h1>{{ title }}</h1>
            <div class="connection-status">
                <div class="connection-item">
                    <span class="status-indicator" id="mqtt-status"></span>
                    <span>MQTT</span>
                </div>
                <div class="connection-item">
                    <span class="status-indicator" id="redis-status"></span>
                    <span>Redis</span>
                </div>
            </div>
        </div>
        <div class="monitor-controls">
            <button id="start-monitor" class="btn btn-success">Start Monitoring</button>
            <button id="stop-monitor" class="btn btn-danger">Stop Monitoring</button>
            <button id="clear-messages" class="btn btn-secondary">Clear Messages</button>
        </div>
    </div>
    
    <div class="message-filters">
        <div class="filter-group">
            <label for="source-filter">Source:</label>
            <select id="source-filter">
                <option value="">All Sources</option>
                <option value="mqtt">MQTT</option>
                <option value="redis">Redis</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="topic-filter">Topic Filter:</label>
            <input type="text" id="topic-filter" placeholder="Filter by topic...">
        </div>
        <div class="filter-group">
            <label for="auto-refresh">Auto Refresh:</label>
            <div class="auto-refresh">
                <input type="checkbox" id="auto-refresh">
                <span>Every 5 seconds (optional)</span>
            </div>
        </div>
        <div class="filter-group">
            <button id="refresh-now" class="btn btn-primary">Refresh Now</button>
        </div>
    </div>
    
    <div class="messages-container">
        <div class="messages-header">
            <span>Recent Messages</span>
            <span class="message-count" id="message-count">0</span>
        </div>
        <div class="messages-list" id="messages-list">
            <div class="no-messages">
                <p>No messages yet. Start monitoring to see MQTT and Redis messages.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const messagesList = document.getElementById('messages-list');
    const messageCount = document.getElementById('message-count');
    const startBtn = document.getElementById('start-monitor');
    const stopBtn = document.getElementById('stop-monitor');
    const clearBtn = document.getElementById('clear-messages');
    const sourceFilter = document.getElementById('source-filter');
    const topicFilter = document.getElementById('topic-filter');
    const autoRefresh = document.getElementById('auto-refresh');
    const refreshNowBtn = document.getElementById('refresh-now');
    
    let refreshInterval;
    let allMessages = [];
    let lastRefreshTime = null;
    
    // Start monitoring
    startBtn.addEventListener('click', function() {
        console.log('Starting monitoring...');
        fetch('{% url "mqtt_plugin:monitor_control" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: 'action=start'
        })
        .then(response => response.json())
        .then(data => {
            console.log('Start monitoring response:', data);
            if (data.status === 'started') {
                updateStatus(true);
                if (autoRefresh.checked) {
                    startAutoRefresh();
                }
                // Fetch messages immediately after starting
                fetchMessages();
            }
        })
        .catch(error => {
            console.error('Error starting monitoring:', error);
        });
    });
    
    // Stop monitoring
    stopBtn.addEventListener('click', function() {
        console.log('Stopping monitoring...');
        fetch('{% url "mqtt_plugin:monitor_control" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: 'action=stop'
        })
        .then(response => response.json())
        .then(data => {
            console.log('Stop monitoring response:', data);
            if (data.status === 'stopped') {
                updateStatus(false);
                stopAutoRefresh();
            }
        })
        .catch(error => {
            console.error('Error stopping monitoring:', error);
        });
    });
    
    // Clear messages
    clearBtn.addEventListener('click', function() {
        allMessages = [];
        displayMessages();
    });
    
    // Manual refresh
    refreshNowBtn.addEventListener('click', function() {
        fetchMessages();
    });
    
    // Filter messages
    function filterMessages() {
        const source = sourceFilter.value.toLowerCase();
        const topic = topicFilter.value.toLowerCase();
        
        return allMessages.filter(msg => {
            const sourceMatch = !source || msg.source.toLowerCase() === source;
            const topicMatch = !topic || msg.topic.toLowerCase().includes(topic);
            return sourceMatch && topicMatch;
        });
    }
    
    // Display messages
    function displayMessages() {
        const filteredMessages = filterMessages();
        // Show total message count, not filtered count
        messageCount.textContent = allMessages.length;
        
        if (filteredMessages.length === 0) {
            if (allMessages.length === 0) {
                messagesList.innerHTML = '<div class="no-messages"><p>No messages yet. Start monitoring to see MQTT and Redis messages.</p></div>';
            } else {
                messagesList.innerHTML = '<div class="no-messages"><p>No messages match the current filters.</p></div>';
            }
            return;
        }
        
        const html = filteredMessages.slice(-20).reverse().map(msg => {
            const timestamp = new Date(msg.timestamp).toLocaleString();
            const sourceClass = msg.source.toLowerCase();
            const payloadInfo = formatPayload(msg.payload);
            
            return `
                <div class="message-item">
                    <div class="message-header">
                        <span class="message-source source-${sourceClass}">${msg.source}</span>
                        <span class="message-timestamp">${timestamp}</span>
                    </div>
                    <div class="message-topic">${msg.topic}</div>
                    <div class="message-payload ${payloadInfo.type}">
                        <div class="payload-type ${payloadInfo.type}">${payloadInfo.type}</div>
                        <div class="payload-content">${payloadInfo.content}</div>
                    </div>
                    <div class="message-meta">
                        <div class="meta-item">
                            <span>QoS:</span>
                            <span>${msg.qos}</span>
                        </div>
                        <div class="meta-item">
                            <span>Retain:</span>
                            <span>${msg.retain ? 'Yes' : 'No'}</span>
                        </div>
                        <div class="meta-item">
                            <span>ID:</span>
                            <span>${msg.id}</span>
                        </div>
                        <div class="meta-item">
                            <span>Type:</span>
                            <span>${payloadInfo.isJson ? 'JSON' : 'Text'}</span>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        messagesList.innerHTML = html;
    }
    
    // Fetch messages from API
    function fetchMessages() {
        const url = '{% url "mqtt_plugin:monitor_api" %}';
        const params = new URLSearchParams();
        
        // Only fetch new messages if we have a last refresh time
        if (lastRefreshTime) {
            params.append('since', lastRefreshTime);
        }
        
        const fullUrl = params.toString() ? `${url}?${params.toString()}` : url;
        
        fetch(fullUrl)
        .then(response => response.json())
        .then(data => {
            const newMessages = data.messages || [];
            
            // If we're fetching since a specific time, append new messages
            if (lastRefreshTime) {
                allMessages = [...allMessages, ...newMessages];
            } else {
                // First load or manual refresh - replace all messages
                allMessages = newMessages;
            }
            
            // Keep only the last 50 messages to prevent memory issues
            if (allMessages.length > 50) {
                allMessages = allMessages.slice(-50);
            }
            
            lastRefreshTime = new Date().toISOString();
            displayMessages();
            updateConnectionStatus(data.monitoring);
            
            // Debug logging
            console.log('Fetched messages:', newMessages.length, 'Total messages:', allMessages.length);
        })
        .catch(error => {
            console.error('Error fetching messages:', error);
            // Show error message to user
            messagesList.innerHTML = '<div class="no-messages"><p>Error fetching messages. Check console for details.</p></div>';
        });
    }
    
    // Update connection status
    function updateConnectionStatus(monitoring) {
        const mqttStatus = document.getElementById('mqtt-status');
        const redisStatus = document.getElementById('redis-status');
        
        if (monitoring) {
            mqttStatus.className = 'status-indicator status-running';
            redisStatus.className = 'status-indicator status-running';
        } else {
            mqttStatus.className = 'status-indicator status-stopped';
            redisStatus.className = 'status-indicator status-stopped';
        }
    }
    
    // Update monitoring status
    function updateStatus(running) {
        if (running) {
            startBtn.disabled = true;
            stopBtn.disabled = false;
        } else {
            startBtn.disabled = false;
            stopBtn.disabled = true;
        }
    }
    
    // Auto refresh
    function startAutoRefresh() {
        if (refreshInterval) clearInterval(refreshInterval);
        refreshInterval = setInterval(fetchMessages, 5000); // Changed to 5 seconds
    }
    
    function stopAutoRefresh() {
        if (refreshInterval) {
            clearInterval(refreshInterval);
            refreshInterval = null;
        }
    }
    
    // Toggle auto refresh
    autoRefresh.addEventListener('change', function() {
        if (this.checked) {
            startAutoRefresh();
        } else {
            stopAutoRefresh();
        }
    });
    
    // Add visual feedback for refresh button
    refreshNowBtn.addEventListener('click', function() {
        const originalText = this.textContent;
        this.textContent = 'Refreshing...';
        this.disabled = true;
        
        setTimeout(() => {
            this.textContent = originalText;
            this.disabled = false;
        }, 1000);
    });
    
    // Filter events
    sourceFilter.addEventListener('change', displayMessages);
    topicFilter.addEventListener('input', displayMessages);
    
    // Utility functions
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Pretty print JSON with syntax highlighting
    function prettyPrintJson(jsonString) {
        try {
            const parsed = JSON.parse(jsonString);
            const pretty = JSON.stringify(parsed, null, 2);
            return syntaxHighlight(pretty);
        } catch (e) {
            return escapeHtml(jsonString);
        }
    }
    
    // Add syntax highlighting to JSON
    function syntaxHighlight(json) {
        json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
            let cls = 'json-number';
            if (/^"/.test(match)) {
                if (/:$/.test(match)) {
                    cls = 'json-key';
                } else {
                    cls = 'json-string';
                }
            } else if (/true|false/.test(match)) {
                cls = 'json-boolean';
            } else if (/null/.test(match)) {
                cls = 'json-null';
            }
            return '<span class="' + cls + '">' + match + '</span>';
        });
    }
    
    // Format message payload for display
    function formatPayload(payload) {
        // Try to detect if it's JSON
        const trimmed = payload.trim();
        if ((trimmed.startsWith('{') && trimmed.endsWith('}')) || 
            (trimmed.startsWith('[') && trimmed.endsWith(']'))) {
            return {
                content: prettyPrintJson(payload),
                type: 'json',
                isJson: true
            };
        }
        
        // Check if it looks like JSON but might be malformed
        if (trimmed.includes('{') || trimmed.includes('[')) {
            try {
                JSON.parse(payload);
                return {
                    content: prettyPrintJson(payload),
                    type: 'json',
                    isJson: true
                };
            } catch (e) {
                // Not valid JSON, treat as raw
            }
        }
        
        // Raw text
        return {
            content: escapeHtml(payload),
            type: 'raw',
            isJson: false
        };
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Initial load
    fetchMessages();
    updateStatus(false);
    
    // Don't start auto-refresh by default
    autoRefresh.checked = false;
});
</script>
{% endblock %}
